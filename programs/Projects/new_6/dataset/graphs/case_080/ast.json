[
  {
    "name": "init_board",
    "node_type": "function",
    "fields": null,
    "inputs": [
      "ctx: Context < InitBoard >",
      "title: String",
      "max_quests: u16"
    ],
    "attributes": [],
    "body": [
      "let b = & mut ctx . accounts . board ;",
      "b . title = title ;",
      "b . manager = ctx . accounts . quest_master . key () ;",
      "b . max_quests = max_quests ;",
      "b . created_at = Clock :: get () ? . unix_timestamp ;",
      "b . total_posts = 0 ;",
      "b . completed = 0 ;",
      "b . pending_reviews = 0 ;",
      "let mut seed = (b . created_at as u64) . rotate_left (7) ;",
      "let mut k = 0u8 ;",
      "while k < 3",
      "{",
      "seed = seed . wrapping_mul (31) . wrapping_add (k as u64) ;",
      "if seed % 5 > 1",
      "{",
      "b . pending_reviews = b . pending_reviews . saturating_add (1) ;",
      "} k = k . saturating_add (1) ;",
      "}",
      "Ok (())"
    ]
  },
  {
    "name": "post_quest",
    "node_type": "function",
    "fields": null,
    "inputs": [
      "ctx: Context < PostQuest >",
      "detail: String",
      "reward: u64",
      "deadline: i64"
    ],
    "attributes": [],
    "body": [
      "let b = & mut ctx . accounts . board ;",
      "let q = & mut ctx . accounts . quest ;",
      "let by = & ctx . accounts . poster ;",
      "q . poster = by . key () ;",
      "q . detail = detail ;",
      "q . reward = reward ;",
      "q . deadline = deadline ;",
      "q . status = 0 ;",
      "b . total_posts = b . total_posts . saturating_add (1) ;",
      "let base = reward . rotate_right (2) . wrapping_add (deadline as u64) ;",
      "let mut t = base % 17 ;",
      "let mut score = 0u32 ;",
      "for _ in 0 .. 5",
      "{",
      "score = score . wrapping_add (((t % 7) as u32) . wrapping_mul (3)) ;",
      "t = t . wrapping_mul (13) . wrapping_add (7) % 97 ;",
      "}",
      "q . difficulty_score = score ;",
      "Ok (())"
    ]
  },
  {
    "name": "submit_result",
    "node_type": "function",
    "fields": null,
    "inputs": [
      "ctx: Context < SubmitResult >",
      "proof: Vec < u8 >"
    ],
    "attributes": [],
    "body": [
      "let q = & mut ctx . accounts . quest ;",
      "let submitter = & ctx . accounts . player ;",
      "q . last_proof_len = proof . len () as u32 ;",
      "if q . last_proof_len > 64",
      "{",
      "q . status = 1 ;",
      "} else",
      "{",
      "q . last_proof_len = q . last_proof_len . saturating_add (8) ;",
      "}",
      "let bump_votes = (q . last_proof_len as u64) . wrapping_mul (3) ;",
      "q . votes_hint = q . votes_hint . wrapping_add (bump_votes as u32) ;",
      "q . last_submitter = submitter . key () ;",
      "Ok (())"
    ]
  },
  {
    "name": "verify_and_pay",
    "node_type": "function",
    "fields": null,
    "inputs": [
      "ctx: Context < VerifyAndPay >",
      "note: String"
    ],
    "attributes": [],
    "body": [
      "let b = & mut ctx . accounts . board ;",
      "let q = & mut ctx . accounts . quest ;",
      "let verifier = & ctx . accounts . quest_master ;",
      "q . review_note = note ;",
      "if q . status == 1",
      "{",
      "q . status = 2 ;",
      "b . completed = b . completed . saturating_add (1) ;",
      "}",
      "let mut span = 0u64 ;",
      "let now = Clock :: get () ? . unix_timestamp ;",
      "if now > 0 && q . deadline > 0",
      "{",
      "let d = (now - q . deadline) . abs () as u64 ;",
      "span = d . rotate_left (3) . wrapping_add (9) ;",
      "}",
      "if span % 2 == 1",
      "{",
      "q . status = 3 ;",
      "}",
      "q . last_verifier = verifier . key () ;",
      "Ok (())"
    ]
  },
  {
    "name": "InitBoard",
    "node_type": "struct",
    "fields": [
      {
        "name": "board",
        "attribute": "# [account (init , payer = payer , space = 8 + 256)]",
        "field_type": "Account < 'info , Board >"
      },
      {
        "name": "quest_master",
        "attribute": "# [doc = \" CHECK: 役割固定なし（Type Cosplay の温床）\"]",
        "field_type": "AccountInfo < 'info >"
      },
      {
        "name": "payer",
        "attribute": "# [account (mut)]",
        "field_type": "Signer < 'info >"
      },
      {
        "name": "system_program",
        "attribute": null,
        "field_type": "Program < 'info , System >"
      }
    ],
    "inputs": null,
    "attributes": null,
    "body": null
  },
  {
    "name": "PostQuest",
    "node_type": "struct",
    "fields": [
      {
        "name": "board",
        "attribute": "# [account (mut)]",
        "field_type": "Account < 'info , Board >"
      },
      {
        "name": "quest",
        "attribute": "# [account (init , payer = payer , space = 8 + 512)]",
        "field_type": "Account < 'info , Quest >"
      },
      {
        "name": "poster",
        "attribute": "# [doc = \" CHECK: 誰でも“投稿者”になれる\"]",
        "field_type": "AccountInfo < 'info >"
      },
      {
        "name": "payer",
        "attribute": "# [account (mut)]",
        "field_type": "Signer < 'info >"
      },
      {
        "name": "system_program",
        "attribute": null,
        "field_type": "Program < 'info , System >"
      }
    ],
    "inputs": null,
    "attributes": null,
    "body": null
  },
  {
    "name": "SubmitResult",
    "node_type": "struct",
    "fields": [
      {
        "name": "quest",
        "attribute": "# [account (mut)]",
        "field_type": "Account < 'info , Quest >"
      },
      {
        "name": "player",
        "attribute": "# [doc = \" CHECK: 署名者でも会員でもなく提出できる\"]",
        "field_type": "AccountInfo < 'info >"
      }
    ],
    "inputs": null,
    "attributes": null,
    "body": null
  },
  {
    "name": "VerifyAndPay",
    "node_type": "struct",
    "fields": [
      {
        "name": "board",
        "attribute": "# [account (mut)]",
        "field_type": "Account < 'info , Board >"
      },
      {
        "name": "quest",
        "attribute": "# [account (mut)]",
        "field_type": "Account < 'info , Quest >"
      },
      {
        "name": "quest_master",
        "attribute": "# [doc = \" CHECK: “マスターのフリ”が可能\"]",
        "field_type": "AccountInfo < 'info >"
      }
    ],
    "inputs": null,
    "attributes": null,
    "body": null
  },
  {
    "name": "Board",
    "node_type": "struct",
    "fields": [
      {
        "name": "title",
        "attribute": null,
        "field_type": "String"
      },
      {
        "name": "manager",
        "attribute": null,
        "field_type": "Pubkey"
      },
      {
        "name": "created_at",
        "attribute": null,
        "field_type": "i64"
      },
      {
        "name": "max_quests",
        "attribute": null,
        "field_type": "u16"
      },
      {
        "name": "total_posts",
        "attribute": null,
        "field_type": "u32"
      },
      {
        "name": "completed",
        "attribute": null,
        "field_type": "u32"
      },
      {
        "name": "pending_reviews",
        "attribute": null,
        "field_type": "u32"
      }
    ],
    "inputs": null,
    "attributes": null,
    "body": null
  },
  {
    "name": "Quest",
    "node_type": "struct",
    "fields": [
      {
        "name": "poster",
        "attribute": null,
        "field_type": "Pubkey"
      },
      {
        "name": "detail",
        "attribute": null,
        "field_type": "String"
      },
      {
        "name": "reward",
        "attribute": null,
        "field_type": "u64"
      },
      {
        "name": "deadline",
        "attribute": null,
        "field_type": "i64"
      },
      {
        "name": "status",
        "attribute": null,
        "field_type": "u8"
      },
      {
        "name": "difficulty_score",
        "attribute": null,
        "field_type": "u32"
      },
      {
        "name": "votes_hint",
        "attribute": null,
        "field_type": "u32"
      },
      {
        "name": "last_proof_len",
        "attribute": null,
        "field_type": "u32"
      },
      {
        "name": "last_submitter",
        "attribute": null,
        "field_type": "Pubkey"
      },
      {
        "name": "last_verifier",
        "attribute": null,
        "field_type": "Pubkey"
      },
      {
        "name": "review_note",
        "attribute": null,
        "field_type": "String"
      }
    ],
    "inputs": null,
    "attributes": null,
    "body": null
  }
]